# Active Context

## Текущий фокус
- Подготовка к фиксации текущих uncommitted изменений в e2e/lobby-4players.spec.ts, src/components/Lobby.vue, и src/stores/gameStore.ts
- Очистка результатов предыдущего голосования перед началом нового голосования/раунда (реализовано)
- Стабильность PeerJS и восстановление соединений: детерминированная смена/восстановление хоста, корректный discovery (реализовано)

## Недавние изменения

### CLAUDE.md и настройки документации (коммит 3d27ca9)
- Создан полный CLAUDE.md с архитектурной документацией для Claude Code
- Добавлен .claude/settings.local.json для разрешений E2E тестов
- Обновлен progress.md с актуальной дорожной картой

### Предыдущие изменения в gameStore.ts (реализовано):
- Добавлен метод resetVotingState(), который очищает:
  - gameState.votes, gameState.voteCounts, gameState.bets.
  - Для режима advanced дополнительно: gameState.guesses, gameState.roundWinners, gameState.answeringPlayerId, gameState.advancedAnswer.
- В drawCard() метод resetVotingState() вызывается сразу после установки нового вопроса и рассылки состояния в фазе drawing_question, но до переключения фазы на voting/secret_voting. Это гарантирует, что старые выборы/ставки не попадут в новый раунд.
- Сохранена очистка раундовых данных в finishRoundHostOnly() при переходе из results/advanced_results к следующему раунду, чтобы итоги были доступны на экране результатов.

- Ранее (актуально для контекста):
  - Введены базовая/advanced колоды (basicDeck/advancedDeck) и строгое чередование режимов по раундам.
  - Улучшен discovery/restore логика хоста и клиентов, добавлены валидации доступности кандидатов и чёрные списки на один цикл discovery.
  - Интегрирован debug-флаг через utils/debug.ts и computed isDebug в store.

## Решенные проблемы
- «Перед голосованием надо очищать результат, чтобы старый выбор не учитывался в новом раунде» — реализовано через resetVotingState() и вызов перед фазой голосования.

## Следующие шаги
- Зафиксировать текущие uncommitted изменения (e2e/lobby-4players.spec.ts, src/components/Lobby.vue, src/stores/gameStore.ts)
- Продолжить работу над unit-тестами для gameStore (переходы фаз, консенсус, миграция хоста)
- Завершить UI индикаторы статусов соединения/переподключения
- Проверить UI-flow:
  1) Новый вопрос тянется (drawing_question) → при переходе в voting/secret_voting старые голоса/ставки отсутствуют.
  2) В advanced убедиться, что прежние guesses/roundWinners/answeringPlayerId/advancedAnswer не переносятся между раундами.

Date: 2025-08-09

## Обновление: стабильность PeerJS, потеря связи и восстановление (контекст)
Корневая причина:
- Смена peerId у хоста при потерях связи, клиенты продолжали коннект к старому id.

Исправления в коде:
- Детерминированный hostId на основе roomId в peerService.createHost(roomId).
- Мягкое пересоздание Peer с тем же ID при сетевых сбоях.
- Усилен discovery (reachability, blacklist кандидатов), отменены ложные «успехи» восстановления без валидного state.

Ожидаемый эффект:
- Стабильный hostId и корректные реконнекты клиентов.

Проверка:
- Симуляция потери/восстановления связи; подтверждение сохранения hostId и успешных автоподключений клиентов.

## Обновление: разделение колод вопросов по раундам (контекст)
- Две независимые перемешанные колоды на игру; автоматическая перезагрузка исчерпанной колоды.
- Чередование basic/advanced по номеру раунда, snapshot активной колоды в gameState.questionCards.

Затронутые места:
- gameStore.initializeGame, drawCard, finishRoundHostOnly.

Ожидаемый эффект:
- Исключено смешивание типов вопросов, бесшовная игра при исчерпании колоды.

## Debug-флаг и отладка (контекст)
- utils/debug.ts: isDebugEnabled(), enable/disable.
- computed isDebug в store; логирование snapshot/transition через debugSnapshot/logAction/watch.

## Риски/заметки
- Убедиться, что компоненты UI не кэшируют локально прошлый выбор вне gameState.
- В advanced режиме проверять, что UI «победителей» и «догадок» не опирается на прежние реактивные ссылки, которые могли сохраниться.
