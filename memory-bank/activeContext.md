# Active Context

## Текущий фокус
- Продолжение развития тестовой инфраструктуры и улучшение стабильности E2E тестов
- Дальнейшие улучшения логики лобби и UX компонентов
- Развитие unit-тестов для gameStore и критических переходов

## Недавние изменения

### Обновление memory bank и настроек разрешений (коммит 36871f7)
- Обновлены activeContext.md и progress.md с актуальными изменениями
- Уточнен статус uncommitted изменений и документации
- Расширены разрешения в settings.local.json для git-команд и lint/build

### Улучшения устойчивости лобби (коммит bbc3eef)
- Очистка localStorage при создании/подключении к комнате (сохраняется nickname)
- Улучшен responsive layout в GameField для лучшей адаптивности
- Добавлены E2E тесты для смены nickname и переназначения хоста

### Предыдущие изменения в gameStore.ts (реализовано):
- Добавлен метод resetVotingState(), который очищает:
  - gameState.votes, gameState.voteCounts, gameState.bets.
  - Для режима advanced дополнительно: gameState.guesses, gameState.roundWinners, gameState.answeringPlayerId, gameState.advancedAnswer.
- В drawCard() метод resetVotingState() вызывается сразу после установки нового вопроса и рассылки состояния в фазе drawing_question, но до переключения фазы на voting/secret_voting. Это гарантирует, что старые выборы/ставки не попадут в новый раунд.
- Сохранена очистка раундовых данных в finishRoundHostOnly() при переходе из results/advanced_results к следующему раунду, чтобы итоги были доступны на экране результатов.

- Ранее (актуально для контекста):
  - Введены базовая/advanced колоды (basicDeck/advancedDeck) и строгое чередование режимов по раундам.
  - Улучшен discovery/restore логика хоста и клиентов, добавлены валидации доступности кандидатов и чёрные списки на один цикл discovery.
  - Интегрирован debug-флаг через utils/debug.ts и computed isDebug в store.

## Решенные проблемы
- «Перед голосованием надо очищать результат, чтобы старый выбор не учитывался в новом раунде» — реализовано через resetVotingState() и вызов перед фазой голосования.

## Следующие шаги
- Продолжить работу над unit-тестами для gameStore (переходы фаз, консенсус, миграция хоста)
- Завершить UI индикаторы статусов соединения/переподключения  
- Проверить UI-flow:
  1) Новый вопрос тянется (drawing_question) → при переходе в voting/secret_voting старые голоса/ставки отсутствуют.
  2) В advanced убедиться, что прежние guesses/roundWinners/answeringPlayerId/advancedAnswer не переносятся между раундами.
- Расширить E2E тестовое покрытие для сложных сценариев (миграция хоста, восстановление соединения)

Date: 2025-08-10

## Обновление: стабильность PeerJS, потеря связи и восстановление (контекст)
Корневая причина:
- Смена peerId у хоста при потерях связи, клиенты продолжали коннект к старому id.

Исправления в коде:
- Детерминированный hostId на основе roomId в peerService.createHost(roomId).
- Мягкое пересоздание Peer с тем же ID при сетевых сбоях.
- Усилен discovery (reachability, blacklist кандидатов), отменены ложные «успехи» восстановления без валидного state.

Ожидаемый эффект:
- Стабильный hostId и корректные реконнекты клиентов.

Проверка:
- Симуляция потери/восстановления связи; подтверждение сохранения hostId и успешных автоподключений клиентов.

## Обновление: разделение колод вопросов по раундам (контекст)
- Две независимые перемешанные колоды на игру; автоматическая перезагрузка исчерпанной колоды.
- Чередование basic/advanced по номеру раунда, snapshot активной колоды в gameState.questionCards.

Затронутые места:
- gameStore.initializeGame, drawCard, finishRoundHostOnly.

Ожидаемый эффект:
- Исключено смешивание типов вопросов, бесшовная игра при исчерпании колоды.

## Debug-флаг и отладка (контекст)
- utils/debug.ts: isDebugEnabled(), enable/disable.
- computed isDebug в store; логирование snapshot/transition через debugSnapshot/logAction/watch.

## Риски/заметки
- Убедиться, что компоненты UI не кэшируют локально прошлый выбор вне gameState.
- В advanced режиме проверять, что UI «победителей» и «догадок» не опирается на прежние реактивные ссылки, которые могли сохраниться.
