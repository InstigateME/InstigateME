# Active Context

Date: 2025-08-06

Focus: Починка развала сети после перезагрузки хоста (PeerJS) и улучшение логики восстановления/дискवरी/элекции хоста, устранение ложных "Session successfully restored" без фактического коннекта.

## Наблюдаемая проблема (симптомы из логов)

- После reload хоста клиенты пытаются восстановиться и детерминированно выбирают кандидата с min id: "3a8423b2-..." как хоста.
- PeerJS отвечает "Could not connect to peer ..." для этого id: фактический peer не существует (id сменился) или не доступен.
- Алгоритм универсального discovery снова выбирает тот же недоступный id, затем 5 неудачных реконнектов к одному peer.
- В конце выводится "Session successfully restored" несмотря на отсутствие state sync — ложноположительный статус, сеть логически "развалилась".

## Корневые причины

1) Отсутствие строгой валидации доступности кандидата-хоста перед выбором (детерминированный min id выбирается без reachability).
2) Нет blacklist-а для временно недоступных кандидатов в рамках одного discovery цикла — повторяем попытки к одному и тому же peerId.
3) Логика "Session successfully restored" срабатывала до проверки получения валидного состояния (players/phase).
4) Возможен параллельный старт discovery (гонки) и опора на кэш якорного снапшота без живой проверки.
5) При reload хоста peerId мог измениться, а клиенты продолжали коннектиться к старому id.

## Внесённые фиксы (код)

Файл: src/stores/gameStore.ts

1) Универсальный discovery с валидацией доступности и blacklist:
   - Добавлен createCandidateBlacklist() и проверка reachability перед выбором детерминированного кандидата.
   - Если lastKnownHost недоступен — заносится в blacklist и не переиспользуется.
   - Перед fallback по min id выполняется короткий ping/handshake (host_discovery_request) через текущий основной peer или временный peerjs instance с таймаутом 2s.

2) tryConnectToKnownHost переписан:
   - Использует существующий mainPeer из peerService, чтобы избежать гонок и множества временных Peer.
   - Корректные таймауты, закрытие temp соединений, возврат HostDiscoveryResponsePayload только если isHost=true.

3) Строже критерий успешного восстановления:
   - "Session successfully restored" теперь ставится только если получено валидное состояние (есть игроки и прошёл sync).
   - Иначе: connectionStatus='disconnected', фиксация ошибки restore_state_missing.

4) Quick discovery:
   - Используется основной peer; сохраняются действительные соединения в пул peerService, а не закрываются безусловно.
   - Короткий общий таймаут 2s и безопасная очистка только «несохранившихся» соединений.

5) Host restore path:
   - При restoreAsHost происходит ремап старого hostId на новый, рассылка snapshot и host_recovery_announcement, а также резервный new_host_id.
   - Сохраняется snapshot в storageSafe с TTL для быстрых reload.

6) Общая устойчивость:
   - Добавлены дополнительные защитные логи, валидация litUpPlayerId, синхронизация phase/gameMode при отправках, повторные запросы state и peer_list с экспоненциальной задержкой.

## Ожидаемый эффект

- Клиенты перестанут зацикливаться на недоступном peerId; discovery перебирает кандидатов и выбирает только достижимого хоста.
- Исключены ложные «успехи» восстановления без действительного состояния.
- При перезагрузке хоста клиенты либо обнаруживают его через announcement/snapshot, либо корректно проводят миграцию на нового детерминированного доступного лидера.

## Риски/долги

- Стабильный хост ID лучше обеспечивать через стабильный roomId -> persisted hostPeerId (частично реализовано в peerService.createHost(roomId)), но стоит проверить полный цикл инициализации/очистки в peerService.
- Нужен audit на предмет возможного двойного запуска discovery (локи/флаги реентерабельности в gameStore при вызовах).
- В некоторых местах есть зависимости от peerService API (getPeer, addConnection, hasConnection и т.п.) — требуется убедиться, что реализации соответствуют (см. peerService.ts).

## Следующие шаги

- Прогнать e2e сценарий: хост создал комнату -> подключились клиенты -> хост перезагрузил страницу -> клиенты не теряют сеть: либо восстанавливаются к тому же хосту, либо корректно выбирают нового доступного.
- Проверить логи клиентской стороны: отсутствие повторяющихся попыток к одному и тому же недоступному id, успешный выбор достижимого хоста.
- При необходимости усилить leader election/heartbeat TTL в peerService.
