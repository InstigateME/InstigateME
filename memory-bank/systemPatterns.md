# System Patterns — GameCenter

## Архитектура

- Клиентское SPA (Vue 3 + Vite + TypeScript).
- Состояние приложения — Pinia stores: gameStore, hostMigration, counter (вспомогательный).
- Маршрутизация — Vue Router (src/router/index.ts) со страницами/вью: MainMenu, Lobby, GameField.
- Сервисы — изолированная логика P2P в src/services/peerService.ts и библиотека PeerJS.
- Типы — централизованы в src/types/game.ts.
- Тестирование — unit (Vitest) в src/__tests__ и e2e (Playwright) в e2e/.

## Ключевые паттерны

1) Разделение ответственности:
    - Компоненты — UI и минимальная координация.
    - Stores — источник правды для состояния и доменных операций.
    - Services — интеграция с внешними системами (P2P/сеть).

2) Событийно‑ориентированное взаимодействие:
    - peerService эмитит/слушает события соединения и игрового обмена.
    - stores подписываются/инициируют действия, обновляя состояние.

3) Типобезопасность:
    - Все доменные структуры — через types/game.ts.
    - Сообщения/ивенты P2P обязательно описывать типами/дисриминирующими юнионами.

4) Надёжность P2P:
    - ОБЯЗАТЕЛЬНО: быстрое восстановление состояния при потере соединения.
    - ОБЯЗАТЕЛЬНО: стоп игра при потере хоста и понятный процесс выбора нового хоста.
    - Обработка реконнектов, таймаутов, деградации канала.
    - Миграция хоста через hostMigration store (перехват лидерства, ресинк состояния).

5) Тестируемость:
    - Stores и утилиты — unit на Vitest.
    - Критические пользовательские сценарии — Playwright e2e.

## Связи компонентов

- MainMenu — точка входа, навигация в Lobby.
- Lobby — настройка/ожидание, подготовка соединений через peerService.
- GameField — активный геймплей, подписка на игровые события, взаимодействие со stores.

## Поток данных (упрощённо)

1) UI действие → store action (например, createLobby/joinLobby/startGame).
2) store вызывает peerService (инициирует P2P, подписки, отправку сообщений).
3) peerService генерирует коллбеки/события → store обновляет состояние.
4) Компоненты реактивно получают обновления из store и рендерят UI.

## Обмен сообщениями (рекомендации)

- Структурировать payload:
    - type: 'lobby:join' | 'game:state' | 'host:migrate' | ...
    - data: { ...строго типизированные поля... }
- Версионирование протокола: protocolVersion в сообщениях (на будущее).
- Идемпотентность ключевых операций (state sync).

## Обработка ошибок и устойчивость

- Централизованные обработчики ошибок в peerService с ретраями.
- guard‑условия в store перед изменением критичных состояний.
- UI‑индикаторы статуса соединения и реконнектов.

## Производительность

- Минимизация лишних реактивных обновлений (вычисляемые селекторы, структурирование state).
- Дедупликация сообщений/отсечка шумовых эвентов.
- Локальные оптимистичные апдейты с последующей верификацией.

## Конфигурация и окружение

- Vite для сборки/дев‑сервера.
- Тестовые конфиги: vitest.config.ts, playwright.config.ts.
- ESLint/Prettier для консистентного стиля.

## Переиспользуемые практики

- Чистые функции для трансформации игрового состояния.
- Action‑ы store как единственная точка мутации state.
- Явные переходы состояния (state machine‑подобный подход приветствуется).

## Логирование

- Поведение должно быть логируемым в виде plantext событий, для передачи в llm и последующего анализа и исправления
  ошибок.
- У логов должны быть обязательные теги, которые помогут понять роль клиент/хост, тип события и его контекст на столько
  полно, что бы llm мог понять, что произошло и как это исправить.
